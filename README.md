# #C#学习笔记

## #.NET基础知识

### #下载.NET

https://dotnet.microsoft.com/zh-cn/download

### 官方文档

https://learn.microsoft.com/zh-cn/dotnet/csharp/

### #.NET 体系结构

- C# 程序在 .NET 上运行，而 .NET 是名为公共语言运行时 (CLR) 的虚执行系统和一组类库。 CLR 是 Microsoft 对公共语言基础结构 (CLI) 国际标准的实现。 CLI 是创建执行和开发环境的基础，语言和库可以在其中无缝地协同工作。

- 用 C# 编写的源代码被编译成符合 CLI 规范的中间语言 (IL)。 IL 代码和资源（如位图和字符串）存储在扩展名通常为 .dll 的程序集中。 程序集包含一个介绍程序集的类型、版本和区域性的清单。

- 执行 C# 程序时，程序集将加载到 CLR。 CLR 会直接执行实时 (JIT) 编译，将 IL 代码转换成本机指令。 CLR 可提供其他与自动垃圾回收、异常处理和资源管理相关的服务。 CLR 执行的代码有时称为“托管代码”。而“非托管代码”被编译成面向特定平台的本机语言。

- 语言互操作性是 .NET 的一项重要功能。 C# 编译器生成的 IL 代码符合公共类型规范 (CTS)。 通过 C# 生成的 IL 代码可以与通过 .NET 版本的 F#、Visual Basic、C++ 生成的代码进行交互。 还有 20 多种与 CTS 兼容的语言。 单个程序集可包含多个用不同 .NET 语言编写的模块。 这些类型可以相互引用，就像它们是用同一种语言编写的一样。

- 除了运行时服务之外，.NET 还包含大量库。 这些库支持多种不同的工作负载。 它们已整理到命名空间中，这些命名空间提供各种实用功能。 这些功能包括文件输入输出、字符串控制、XML 分析、Web 应用程序框架和 Windows 窗体控件。 典型的 C# 应用程序广泛使用 .NET 类库来处理常见的“管道”零碎工作。

### #关于.NET

通用类型系统（CTS）、虚拟执行系统（VES）和公共语言规范（CLS）是.NET框架的三个重要组成部分，它们分别有不同的作用和功能。

- 通用类型系统（CTS）是一种规范，它定义了.NET框架如何定义、使用和管理类型¹。它提供了一个面向对象的模型，支持在.NET框架上实现各种语言¹。它还定义了一组基本的数据类型，如布尔、字节、字符等¹。CTS中的两种主要类型是"""引用类型"""和"""值类"""型¹。引用类型的对象由对对象实际值的引用表示，而值类型的对象由其值表示¹。
- 虚拟执行系统（VES）是一个运行时环境，它负责执行.NET框架中的代码²。它将编译为中间语言（IL）的代码转换为特定平台的机器码，并提供内存管理、异常处理、安全检查等服务²。VES还支持跨语言调试和跨平台部署²。
- 公共语言规范（CLS）是一种规范，它定义了.NET框架中支持的语言之间的互操作性¹。它是CTS的子集，也就是说，CTS中的所有规则也适用于CLS，除非CLS规则更严格¹³。CLS通过定义一组开发人员可以确信在多种语言中都可用的功能来增强和确保语言的互用性³ 。如果一个组件只使用CLS中的规则生成，那么它就被认为是符合CLS的，也就是说，它可以被任何.NET框架支持的语言使用¹。

(1) 常规类型系统和公共语言规范 | Microsoft Learn. https://learn.microsoft.com/zh-cn/dotnet/standard/common-type-system.

(2) CTS、CLS、CLR分别作何解释？ - CSDN博客. https://blog.csdn.net/love_programmer/article/details/112002003.

(3) CTS，CLS，CLR解释 - 橙发 - 博客园. https://www.cnblogs.com/sandaman2019/p/11388033.html.


## ECMA-335 标准
### 公共语言基础结构 （CLI）

本标准定义了公共语言基础结构 （CLI），在该基础结构中，用多种高级语言编写的应用程序可以在不同的系统环境中执行，而无需重写这些应用程序以考虑这些环境的独特特征。本标准由以下部分组成：

- 分区 I：概念和体系结构 – 描述 CLI 的整体体系结构，并提供通用类型系统 （CTS）、虚拟执行系统 （VES） 和公共语言规范 （CLS） 的规范性描述。它还提供了元数据的信息性说明。
- 分区 II：元数据定义和语义 – 提供元数据的规范性描述：其物理布局（作为文件格式）、逻辑内容（作为一组表及其关系）及其语义（从假设的汇编程序 ilasm 中看到）。
- 分区 III：CIL 指令集 – 描述公共中间语言 （CIL） 指令集。

    { 类似于Java字节码 ，或者汇编 }

- 分区 IV：配置文件和库 – 提供 CLI 库的概述，以及它们分解到配置文件和库中的规范。配套文件 CLILibrary.xml 被视为此分区的一部分，但以 XML 格式分发，它提供了 CLI 库中每个类、值类型和接口的详细信息。
分区 V：调试交换格式 – 描述在 CLI 生产者和使用者之间交换调试信息的标准方法。
- 分区 VI：附件 – 包含一些用 CIL 汇编语言 （ILAsm） 编写的示例程序、有关汇编程序特定实现的信息、CIL 指令集的机器可读描述，可用于派生此汇编程序使用的部分语法以及操作 CIL 的其他工具，分区 IV 库设计中使用的一组指南， 和可移植性注意事项。


## 共同语言运行时

共同语言运行时（Common Language Runtime，简称 CLR）是.NET框架的核心组件之一，它负责执行.NET框架中的代码，并提供一些使开发过程更轻松的服务¹。

共同语言运行时的主要功能包括：

- 将编译为中间语言（IL）的代码转换为特定平台的机器码，并优化其性能¹。
- 管理内存，通过垃圾回收器（GC）自动分配和释放内存，避免内存泄漏和其他常见的编程错误¹²。
- 提供跨语言集成，使不同语言编写的对象可以互相通信和集成，因为它们都遵循通用类型系统（CTS）和公共语言规范（CLS）¹²。
- 强制安全性，通过安全检查、代码访问安全性（CAS）和验证机制，保护代码和数据不受恶意或意外的损害¹²。
- 支持版本控制和部署，通过元数据和程序集机制，确保代码具有所需的依赖项和版本信息，简化组件复制和删除任务¹²。
- 提供调试和分析服务，使开发人员可以方便地跟踪、监视和优化代码的执行过程¹²。

共同语言运行时是.NET框架的基础，它为.NET框架支持的所有语言提供了一个统一的运行时环境。你可以使用面向运行时的语言编译器开发托管代码，也就是说，由公共语言运行时管理和执行的代码¹。托管代码具有许多优点，例如跨语言集成、跨语言异常处理、增强的安全性、版本控制和部署支持、简化的组件交互模型等¹。

(1) 公共语言运行时 (CLR) 概述 - .NET | Microsoft Learn. https://learn.microsoft.com/zh-cn/dotnet/standard/clr.

(2) 运行时（runtime）是什么意思？应该怎样深入且直观地理解？ - 知乎. https://www.zhihu.com/question/20607178.

(3) 动态语言运行时概述 - .NET Framework | Microsoft Learn. https://learn.microsoft.com/zh-cn/dotnet/framework/reflection-and-codedom/dynamic-language-runtime-overview.


## 托管代码

- """托管代码"""就是执行过程交由运行时管理的代码。 在这种情况下，相关的运行时称为公共语言运行时 (CLR)，不管使用的是哪种实现（例如 Mono、.NET Framework 或 .NET Core/.NET 5+）。 CLR 负责提取托管代码、将其编译成机器代码，然后执行它。 除此之外，运行时还提供多个重要服务，例如自动内存管理、安全边界和类型安全。
- 如果运行 C/C++ 程序，则运行的代码也称为"""非托管代码"""。 在非托管环境中，程序员需要亲自负责处理相当多的事情。 实际的程序在本质上是操作系统 (OS) 载入内存，然后启动的二进制代码。 其他任何工作 - 从内存管理到安全考虑因素 - 对于程序员来说是一个不小的负担。
- 托管代码是使用可在 .NET 上运行的一种高级语言（例如 C#、Visual Basic、F# 等）编写的。 使用相应的编译器编译以这些语言编写的代码时，无法获得机器代码， 而是获得"""中间语言代码"""，然后运行时会对其进行编译并将其执行。
- C++ 是这条规则的一个例外，因为它也能够生成可在 Windows 上运行的本机非托管二进制代码。

### 中间语言和执行(IL)

- 中间语言是编译使用高级 .NET 语言编写的代码后获得的结果。 对使用其中一种语言编写的代码进行编译后，即可获得 IL 所生成的二进制代码。 必须注意，IL 独立于在运行时顶层运行的任何特定语言。
- 从高级代码生成 IL 后，你很有可能想要运行它。 CLR 此时将接管工作，启动实时 (JIT) 编译过程，或者将代码从 IL 实时编译成可以真正在 CPU 上运行的机器代码。 这样，CLR 就能确切地知道代码的作用，并可以有效地 管理 代码。
- 中间语言有时也称为公共中间语言 (CIL) 或 Microsoft 中间语言 (MSIL)。

### 托管代码互操作性

- 当然，CLR 允许越过托管与非托管环境之间的边界，同时，即使在""" .NET 类库"""中，也有很多代码可以做到这一点。 这称为互操作性，简称 interop。 例如，使用这些机制可以包装某个非托管库以及调用该库。 但是，请务必注意，如果采取这种方法，当代码越过运行时的边界时，实际的执行管理将再次交接到托管代码，因而需要遵守相同的限制。

- 与此类似，C# 语言可让你利用所谓的不安全上下文（指定执行过程不由 CLR 管理的代码片段），在代码中直接使用非托管构造，例如指针。
